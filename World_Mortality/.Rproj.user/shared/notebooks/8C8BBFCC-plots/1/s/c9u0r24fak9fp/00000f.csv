"0","#Code based on code in article:"
"0","#https://github.com/dkobak/excess-mortality/blob/main/baselines-stmf.ipynb"
"0","predict <- function(data){"
"0","#ordering data"
"0","  if(data$time_unit[1] == ""weekly""){"
"0","    data$year_plus_time_unit <- data$year + (data$time / 52)"
"0","  }"
"0","  else "
"0","    data$year_plus_time_unit <- data$year + (data$time / 12)"
"0","#extract data from 2015-2019 (pre-2020) (weeks < 53)"
"0","  pre <- (data[,3] >= 2015) & (data[,3] < 2020) & (data[,4] < 53)"
"0","  m <- max(data[pre, 4]) #12 or 52, depending on weekly or monthly measures"
"0","  "
"0","#one-hot encoding for weeks or months"
"0","  onehot <- matrix(0, sum(pre), m)"
"0","  for (i in 1:sum(pre)) {"
"0","    onehot[i, data[pre,4][i]] <- 1"
"0","  }"
"0","  predictors <- cbind(data[pre,3], onehot) #years in the first column"
"0","  colnames(predictors) <- c('Year', paste0('Week', 1:m))"
"0","  "
"0","#linear regression model without intercept"
"0","  reg <- lm(data[pre,6] ~ 0 + ., data = as.data.frame(predictors))"
"0","#histogram of residuals"
"0","  hist(residuals(reg), breaks=30)"
"0","  plot(data[pre,7], residuals(reg), type='l', ylab='Residuals', xlab='Time')"
"0",""
"0","#plot actual values"
"0","  predictions <- stats::predict(reg)"
"0","  plot(data[pre,7], data[pre, 6], type = ""l"", col = ""blue"", lwd = 2,"
"0","     xlab = ""Time"", ylab = ""Values"","
"0","     main = ""Actual vs. Predicted Over Time"")"
"0",""
"0","#add predictions"
"0","  lines(data[pre,7], predictions, col = ""red"", lwd = 2, lty = 2)"
"0","  legend(""topright"", legend = c(""Actual"", ""Predicted""),"
"0","       col = c(""blue"", ""red""), lty = c(1, 2), lwd = 2)"
"0","  "
"0","#create predictor matrix for 2020 "
"0","  predictors2020 <- cbind(rep(2020, m), diag(m))"
"0","  colnames(predictors2020) <- colnames(predictors)"
"0","  "
"0","#predict baseline values for 2020 using the regression model"
"0","  baseline <- stats::predict(reg, newdata = as.data.frame(predictors2020))"
"0","  if(max(data[,4]==53)){ #baseline week 53 is baseline week 52"
"0","    baseline <- c(baseline, tail(baseline, 1)) "
"0","  }"
"0","  time2020 <- (data[,3]==2020)"
"0",""
"0","  total_time <- ((data[,3] >= 2015) & (data[,3] <= 2016) & (data[,4] < 53)) | ((data[,3]>2016) & (data[,3]<=2020))"
"0","  total_prediction <- c(predictions, baseline)"
"0",""
"0","  plot(data[total_time,7], data[total_time, 6], type = ""l"", col = ""blue"", lwd = 2,"
"0","     xlab = ""Time"", ylab = ""Deaths"","
"0","     main = ""Actual vs. Predicted Over Time"")"
"0","#add predictions"
"0","  lines(data[total_time,7], total_prediction, col = ""red"", lwd = 2, lty = 2)"
"0",""
"0","  legend(""topleft"", legend = c(""Actual"", ""Predicted""),"
"0","       col = c(""blue"", ""red""), lty = c(1, 2), lwd = 2)"
"0","  "
"0","#calculating and plotting difference in actual number of deaths and predicted"
"0","  ind2020 <- (data[,3]==2020)"
"0","  ind2021 <- (data[,3]==2021)"
"0","  diff2020 <- data[ind2020, 6] - baseline[data[ind2020, 4]]"
"0","  diff2021 <- data[ind2021, 6] - baseline[data[ind2021, 4]]"
"0","  plot(diff2020, type='l', xlab='Week', ylab='Excess deaths')"
"0","  title('Excess 2020')"
"0","  plot(diff2021, type='l', xlab='Week', ylab='Excess deaths')"
"0","  title('Excess 2021')"
"0","  "
"0","  excess_begin = begin(data)"
"0","#calculating excess mortality as defined in article"
"0","  total_diff <- sum(diff2020[excess_begin:length(diff2020)])+ sum(diff2021) "
"0","  if(data[1,2]=='Netherlands' || data[1,2]=='Belgium'|| data[1,2]=='Luxembourg' || data[1,2]=='Germany'){"
"0","    total_diff <- total_diff - diff2020[32] - diff2020[33] - diff2020[34] #heat wave in Europe"
"0","  }"
"0","  "
"0","  return(total_diff)"
"0","}"
